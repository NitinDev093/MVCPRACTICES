
@{
    ViewBag.Title = "studentview";
}
<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style type="text/css">

    /* Compact toastr styling */
    #toast-container > .toast {
        font-size: 12px;
        padding: 6px 12px;
        min-width: 160px;
        max-width: 260px;
        border-radius: 6px;
    }

    #toast-container > .toast-title {
        font-size: 13px;
        font-weight: bold;
    }

    #toast-container > .toast-message {
        font-size: 12px;
        line-height: 1.3;
    }
</style>


<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />


<!-- Add New Student Button trigger modal -->
<div class="mb-3">
    <div class="d-flex justify-content-between mt-1">
        <div class="col-md-10">
            <div class="d-flex gap-2">
                <input type="text" class="form-control" style="box-shadow:none; border-color:blue;" placeholder="Student Name" id="searchstudentname" />
                <input type="text" class="form-control" style="box-shadow: none; border-color: blue;" placeholder="Course" id="searchcourse" />
                <button class="btn btn-primary" type="submit" onclick="showstudentdata()">Search</button>
                <a class="btn btn-danger" id="btnExport">Export To Excel</a>

                @* bulk upload templete *@
                <button id="btnDownloadTemplate" class="btn btn-primary">BulkUpload Templets</button>

                @* search par click karne par data show hoga agar hume user ko sirf search par data show karwana hai
        to hum showstudentdata ko hum comment kar denge document ready me jakar*@
            </div>
        </div>
        <div class="col-md-4">
            <button type="button" class="btn btn-success" id="addStudentModel" onclick="openModel()">
                Add New Student
            </button>
        </div>
    </div>

</div>


<!-- Modal -->
<div class="modal fade" id="studentdata" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Add New Student</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-2">
                    <div class="col-md-6 d-flex flex-column">
                        <label>Student Name</label>
                        <input class="form-control" type="text" placeholder="Student Name" id="studentname" />
                    </div>
                    <div class="col-md-6  d-flex flex-column">
                        <label>Student Age</label>
                        <input class="form-control" type="number" placeholder="Student Age" id="studentage" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 d-flex flex-column">
                        <label>Student Qualification</label>
                        <input class="form-control" type="text" placeholder="Student Qualification" id="studentqualification" />
                    </div>
                    <div class="col-md-6  d-flex flex-column">
                        <label>Student Gender</label>
                        <input class="form-control" type="text" placeholder="Student Gender" id="studentgender" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 d-flex flex-column mt-2">
                        <select class="form-control" id="ddlcountry" onchange="statemaster()"></select>
                    </div>
                    <div class="col-md-6  d-flex flex-column mt-2">
                        <select class="form-control" id="ddlstate">
                            <option value="">--Select State--</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="insertstudentdata()">Add New</button>
            </div>
        </div>
    </div>
</div>

@* Student data *@
<table class="table table-bordered table-striped table-hover" id="listonload">
    <thead>
        <tr>
            <th scope="col">Sr.No</th>
            <th scope="col">Student Name</th>
            <th scope="col">Student Age</th>
            <th scope="col">Student Qualification</th>
            <th scope="col">Student Gender</th>
            <th scope="col">Country</th>
            <th scope="col">State</th>
            <th scope="col">Action</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

@* Student delelte model *@

<div class="modal fade" id="deletestudentdata" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Delete Student Data</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="hiddenid" />
                <p>Are you sure want to delete this record?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="deletestudentdata()">Delete</button>
            </div>
        </div>
    </div>
</div>

@* update model *@

<div class="modal fade" id="updatestudentdata" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Update Record</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-2">
                    <input type="hidden" id="hiddenidd" />
                    <div class="col-md-6 d-flex flex-column">
                        <label>Student Name</label>
                        <input class="form-control" type="text" placeholder="Student Name" id="studentnm" />
                    </div>
                    <div class="col-md-6  d-flex flex-column">
                        <label>Student Age</label>
                        <input class="form-control" type="number" placeholder="Student Age" id="studentag" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 d-flex flex-column">
                        <label>Student Qualification</label>
                        <input class="form-control" type="text" placeholder="Student Qualification" id="studentqu" />
                    </div>
                    <div class="col-md-6  d-flex flex-column">
                        <label>Student Gender</label>
                        <input class="form-control" type="text" placeholder="Student Gender" id="studentge" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 d-flex flex-column mt-2">
                        <select class="form-control" id="ddlcountryupdate" onchange="updatestatemaster()"></select>
                    </div>
                    <div class="col-md-6  d-flex flex-column mt-2">
                        <select class="form-control" id="ddlstateupdate">
                            <option value="">--Select State--</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updatestudentdata()">Update</button>
            </div>
        </div>
    </div>
</div>



@* JQUERY CDN *@
<script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>

<script type="text/javascript">

    $(document).ready(function () {


        showstudentdata();
        countrymaster();
        updatecountrymaster();
        
        //export to excel
        $(document).on("click", "#btnExport", function () {
            var studentname = $("#searchstudentname").val();
            var course = $("#searchcourse").val();

            // Controller ExportToExcel ko call karega with query string
            window.location.href = "/Home/ExportToExcel?StudentName=" + studentname + "&Course=" + course;
        });

        //bulk upload templete
        $("#btnDownloadTemplate").click(function () {
            // Direct file download without full page reload
            window.location.href = "/Home/ExportStudentTemplateDynamic?TemplateName=StudentTemplate";
        });


    });

    

    //function for opne model 1st method

    //$(document).ready(function () {
    //    alert("scdd");
    //    $("#addStudentModel").click(function () {
    //        $("#studentdata").modal('show');
    //    });

    //});

    //function for opne model 2nd method for insert
    function openModel() {
        $("#studentdata").modal('show');
    }

    function insertstudentdata() {

        var s_name = $("#studentname").val();
        var s_age = $("#studentage").val();
        var s_qual = $("#studentqualification").val();
        var s_gender = $("#studentgender").val();
        var country_id = $("#ddlcountry").val();
        var state_id = $("#ddlstate").val();
        if (s_name == "") {
            toastr.warning('Student Name Required', 'Warning');
            $("#studentname").focus();
            return;
        }
        else if (s_age == "") {
            alert("Studen Age Required");
            $("#studentage").focus();
            return;
        }
        else if (s_qual == "") {
            alert("Student Qualification Required");
            $("#studentqualification").focus();
            return;
        }
        else if (s_gender == "") {
            alert("Student Gender Required");
            $("#studentgender").focus();
            return;
        }
        else if (country_id == "") {
            alert("Country Required");
            $("#ddlcountry").focus();
            return;
        }
        else if (state_id == "") {
            alert("State Required");
            $("#ddlstate").focus();
            return;
        }

        $.ajax({
            type: "POST",
            url: '/Home/InsertStudentData',
            data: JSON.stringify(
                {
                    studentname: s_name,//left side modal var name:right side id value jo user de raha hai
                    studentage: s_age,
                    studentqualification: s_qual,
                    studentgender: s_gender,
                    countryid: country_id,
                    stateid: state_id,
                }
            ),
            contentType: "application/json; charset=utf-8",
            
            beforeSend: function (){
                showloader();  // Loader show karega
            },
            success: function (response) {
                if (response.success) {
                    // alert(response.message);
                    toastr.success(response.message, "Success");
                    $("#studentdata").modal('hide');
                    resetstudentdata();
                    showstudentdata();
                }
                else {
                    alert("Unable to save student data");
                }
            },
            error: function () {
                alert("Internal server error");
            },
            complete: function () {
                hideloader(); // Loader hide karega (success/error dono me)
            }

        });
    }

    function resetstudentdata() {
        $("#studentname").val('');
        $("#studentage").val('');
        $("#studentqualification").val('');
        $("#studentgender").val('');
        $("#ddlcountry").val('');
        $("#ddlstate").val('');
    }

    //show student data


    function showstudentdata() {
        var studentname = $("#searchstudentname").val();
        var course = $("#searchcourse").val();
        $.ajax({
            type: "GET",
            url: '/Home/ShowStudentData',
            data: {
                StudentName: studentname,
                Course: course,
            },
            contentType: "application/json; charset=utf-8",
            beforeSend: function () {
                showloader();  // Loader show karega
            },

            success: function (response) {
                

                if (response.success) {
                    // ✅ destroy old DataTable if already initialized
                    if ($.fn.DataTable.isDataTable("#listonload")) {
                        $('#listonload').DataTable().clear().destroy();
                    }
                    // ✅ reinitialize with new data
                    $('#listonload').DataTable({
                        data: response.Data,
                        columns: [
                            { data: "sr_no" },
                            { data: "studentname" },
                            { data: "studentage" },
                            { data: "studentqualification" },
                            { data: "studentgender" },
                            { data: "countryname" },
                            { data: "statename" },
                            {
                                data: "id",
                                render: function (data, type, row) {
                                    return `<div class="d-flex gap-1">
                                    <button class="btn btn-primary"
                                        onclick="openupdatemodel('${row.id}',
                                        '${row.studentname}','${row.studentage}',
                                        '${row.studentqualification}','${row.studentgender}','${row.countryid}','${row.stateid}')">
                                        <i class="bi bi-pencil-square"></i>

                                    </button>
                                    <button class="btn btn-danger"
                                        onclick="opendeletemodel('${row.id}')">
                                        <i class="bi bi-trash"></i>
                                    </button></div>`
                                        ;
                                }
                            }
                        ],
                        pageLength: 5,
                        lengthMenu: [5, 10, 20, 50],
                        searching: true,
                        ordering: true,
                    });

                } else {
                    alert("Failed to load student data.");
                }

            },
            error: function () {
                alert("Server error.");
            },
            complete: function () {
                hideloader();  // Loader show karega
            },

        });
    }


    //function showstudentdata() {
    //    $.ajax({
    //        type: "GET",
    //        url: '/Home/ShowStudentData',
    //        contentType: "application/ json; charset = utf - 8",
    //        success: function (response) {
    //            if (response.success) {
    //                let rows = "";
    //                response.Data.forEach(sdm => {
    //                    rows += `<tr>
    //    <td>${sdm.sr_no}</td>
    //    <td>${sdm.studentname}</td>
    //    <td>${sdm.studentage}</td>
    //    <td>${sdm.studentqualification}</td>
    //    <td>${sdm.studentgender}</td>
    //    <td>

    //       <button class="btn btn-primary" onclick="openupdatemodel('${sdm.id}',
    //       '${sdm.studentname}','${sdm.studentage}','${sdm.studentqualification}',
    //       '${sdm.studentgender}')">Edit</button>
    //      <button class="btn btn-danger" onclick="opendeletemodel('${sdm.id}')">Delete</button>

    //   </td>
    //</tr>`;
    //                });
    //                $("#listonload tbody").html(rows);
    //            } else {
    //                alert("Failed to load student data.");
    //            }
    //        },
    //        error: function () {
    //            alert("Server error.");
    //        }
    //    });
    //}

    //delete student data
    function opendeletemodel(id) {//yeah id delete btn se aa raha hai
        $("#hiddenid").val(id);//humne jo input field hidden modal me banya hai usme humne id set kiyea hai
        $("#deletestudentdata").modal('show');
    }
    function deletestudentdata() {
        const id = $("#hiddenid").val();//yeah par humne id nikala hai input field me se jo ki hidden hai
        //alert(id);
        //if we use post method then we have to define json.stringifiy
        //if we use get method then we do not need to define json.stringifiy and ().
        $.ajax({
            type: "POST",
            url: '/Home/DeleteStudentData',
            data: JSON.stringify({ Id: id }),
            contentType: "application/json; charset=utf-8",
            success: function (response) {
                if (response.success) {
                    toastr.success(response.message, "Success");
                    $("#deletestudentdata").modal('hide');
                    showstudentdata();
                } else {
                    toastr.error(response.message, "Error");
                }
            },
            error: function () {
                toastr.error("Server Error", "Error");
            }
        });
    }

    //update student data
    function openupdatemodel(id, studentname, studentage, studentqualification, studentgender, countryid, stateid) {
        //alert(studentgender);
        $("#studentnm").val(studentname);
        $("#studentag").val(studentage);
        $("#studentqu").val(studentqualification);
        $("#studentge").val(studentgender);
        $("#hiddenidd").val(id);
        $("#ddlcountryupdate").val(countryid);
        $("#ddlstateupdate").val(stateid);
        $("#updatestudentdata").modal('show');
    }
    function updatestudentdata() {
        $.ajax({
            type: "POST",
            url: '/Home/UpdateStudentData',
            data: JSON.stringify({
                StudentName: $("#studentnm").val(),
                StudentAge: $("#studentag").val(),
                StudentQual: $("#studentqu").val(),
                StudentGender: $("#studentge").val(),
                Id: $("#hiddenidd").val(),
                CountryId: $("#ddlcountryupdate").val(),
                StateId: $("#ddlstateupdate").val(),
            }),
            contentType: "application/json; charset=utf-8",
            success: function (response) {
                if (response.success) {
                    //alert(response.message);
                    toastr.success(response.message, "Success");

                    $("#updatestudentdata").modal('hide');
                    showstudentdata();
                } else {
                    toastr.error(response.message, "Error");
                }
            },
            error: function () {
                toastr.error("Server Error", "Error");
            }
        });
    }

    //get country
    function countrymaster() {
        $.ajax({
            type: "GET",
            url: '/Home/GetCountry',
            contentType: "application/json; charset=utf-8",
            success: function (response) {
                if (response.success) {

                    // clear old items
                    $("#ddlcountry").empty();

                    // add default option
                    $("#ddlcountry").append($('<option></option>').val("").html("--Select Country--"));

                    // bind data
                    $.each(response.data, function (i, country) {
                        $("#ddlcountry").append(
                            $('<option></option>').val(country.countryid).html(country.countryname)
                        );
                    });

                }
            },

        });
    }


    //get state
    function statemaster() {
        $.ajax({
            type: "GET",
            url: '/Home/GetState',
            data: { CountryId: $("#ddlcountry").val() },
            contentType: "application/json; charset=utf-8",
            success: function (response) {
                if (response.success) {
                    // clear old states
                    $("#ddlstate").empty();

                    // add default option
                    $("#ddlstate").append($('<option></option>').val("").html("--Select State--"));

                    // bind states
                    $.each(response.data, function (i, state) {
                        $("#ddlstate").append(
                            $('<option></option>').val(state.stateid).html(state.statename)
                        );
                    });
                }
            },
        });
    }



    //update country
    function updatecountrymaster() {
        $.ajax({
            type: "GET",
            url: '/Home/GetCountry',
            contentType: "application/json; charset=utf-8",
            success: function (response) {
                if (response.success) {
                    // clear old states
                    $("#ddlcountryupdate").empty();

                    // add default option
                    $("#ddlcountryupdate").append($('<option></option>').val("").html("--Select Country--"));

                    // bind states
                    $.each(response.data, function (i, country) {
                        $("#ddlcountryupdate").append($('<option></option>').val(country.countryid).html(country.countryname));
                    });
                }
            }
        });
    }

    //update state
    function updatestatemaster() {
        $.ajax({
            type: "GET",
            url: '/Home/GetState',
            data: { CountryId: $("#ddlcountryupdate").val() },
            contentType: "application/json; charset=utf-8",
            success: function (response) {
                if (response.success) {
                    // update state
                    $("#ddlstateupdate").empty();

                    // add default option
                    $("#ddlstateupdate").append($('<option></option>').val("").html("--Select State--"));

                    // bind states
                    $.each(response.data, function (i, state) {
                        $("#ddlstateupdate").append(
                            $('<option></option>').val(state.stateid).html(state.statename)
                        );
                    });
                }
            },
        });
    }



</script>
